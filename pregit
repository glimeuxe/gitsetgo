#!/bin/bash

read -p "Clone or link repository? Enter 'clone' or 'link': " action
read -p "Enter repository URL, with or without .git: " repo_url
repo_url=${repo_url%.git}.git
repo_name=$(basename "${repo_url%.git}")

if [[ "$action" =~ ^[Cc]lone$ ]]; then
	if ! git clone "$repo_url"; then
		echo "❌ Failed to clone repository"
		exit 1
	fi
	cd "$repo_name" || { echo "❌ Failed to change directory"; exit 1; }
	echo "✅ Cloned repository to current directory"
elif [[ "$action" =~ ^[Ll]ink$ ]]; then
	if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
		if ! git init; then
			echo "❌ Failed to initialize Git in current directory"
			exit 1
		fi
	fi
	if ! git remote add origin "$repo_url" 2>/dev/null; then
		echo "⚠️ Failed to add 'origin', or it already exists"
	else
		echo "✅ Linked current directory to remote repository"
	fi
else
	echo "❌ Enter 'clone' or 'link'"
	exit 1
fi

read -p "Enter branch name, if not working on main branch (optional): " branch_name
branch_name=${branch_name:-"main"}

if [[ "$branch_name" != "main" ]]; then
	if ! git checkout -b "$branch_name" 2>/dev/null && ! git checkout "$branch_name"; then
		echo "❌ Failed to create or switch to branch"
		exit 1
	fi
fi

echo "✅ Completed pregit for $repo_name/$branch_name"